<!DOCTYPE html>
<meta charset="utf-8">
<script>
  (function (w) {
    var cur = new Date();
    function delta() {
      var prev = cur; cur = new Date();
      return ('       ' + (cur - prev)).slice(-8) + ' msec. ';
    }

    var msgs = [];
    function _log(msg) {
      msgs.push(msg = delta() + msg);
      if (typeof console !== 'undefined') console.log(msg);
      if (typeof $container === 'undefined') return;
      while (msg = msgs.shift()) {
        var div = document.createElement('div');
        div.appendChild(document.createTextNode(msg));
        $container.appendChild(div);
      }
    }
    w._log = _log;
  })(window);

  _log('start');
</script>

<h1>index.html インデックス</h1>

<pre id="container"></pre>

<script>_log('before salt.js');</script>

<!--script src="salt.js"></script-->
<script>
(function (w, d) {
  'use strict';

  var methods = {
      '#': 'getElementById',
      '.': 'getElementsByClassName',
      '@': 'getElementsByName',
      '=': 'getElementsByTagName',
      '*': 'querySelectorAll'
  };

  // https://github.com/james2doyle/saltjs
  // *! Salt.js DOM Selector Lib. By @james2doyle
  w.$ = $;
  function $(selector) {
    var el = (d[methods[selector.slice(0, 1)]](selector.slice(1)));
    return ((el.length < 2) ? el[0]: el); }
})(window, document);
</script>

<script>_log('before main script');</script>

<script>
(function (w) {
  var $container = $('#container');
  w.$container = $container;
  _log('#container loaded');

  function dumpObj(obj, name) {
    for (var i in obj) {
      try {
        var el = obj[i];
        if (typeof el === 'function') el = 'function';
        else el = JSON.stringify(el);
        _log(name + '.' + i + ' = ' + el); }
      catch (e) { } //_log(name + '.' + i + ' ' + e); }
    }
  }

  function newXHR(url, cb) {
    _log('xhr url: ' + url);
    var xhr = function () {
      try { return new XMLHttpRequest(); } catch (e) {}
      try { return new ActiveXObject("Msxml2.XMLHTTP.6.0"); } catch (e) {}
      try { return new ActiveXObject("Msxml2.XMLHTTP.3.0"); } catch (e) {}
      try { return new ActiveXObject("Microsoft.XMLHTTP"); } catch (e) {}
      return null;
    } (); // xhr
    var que = [];
    if (!xhr) return _log('xhr is null'), null;
    //dumpObj(xhr, 'xhr');
    _log('xhr.readyState: ' + xhr.readyState);
    xhr.onreadystatechange = function() {
      if (xhr.readyState == 4) { // DONE
        if (xhr.status == 200) cb(null, xhr.responseText);
        else cb(xhr.status);
        //dumpObj(xhr, '$$xhr');
        next();
      }
    };
    xhr.get  = function () { que.push(['GET',  url]); next(); };
    xhr.post = function (data) { que.push(['POST', url, data]); next(); };
    return xhr;
    function next() {
      if (xhr.readyState !== 4 && xhr.readyState !== 0) return;
      var el = que.shift();
      if (el) {
        xhr.open(el[0], el[1]);
        xhr.send(el[2]);
        executing = true;
      }
    }
  };

  var xhr = newXHR(location.protocol + '//' + location.host + '/xhr/', function (err, data) {
    try {
      _log('xhr res data: ' + data);
      var obj = JSON.parse(data);
      switch (obj.msg) {
        case 'id': break;
      }
    } catch (e) {}
  });
  //xhr.setRequestHeader('Content-Type' , 'text/plain');
  xhr.post('{"msg":"conn"}');

  var wsurl = 'ws://' + location.host + '/ws/';
  try {
    _log('new WebSocket() start');
    var ws = new WebSocket(wsurl, 'echo-protocol');
    _log('new WebSocket() complete');
    ws.onopen = function () {
      _log('onopen!');
      ws.send('message');
      setTimeout(function () { _log('send 1'); ws.send('message 1'); }, 30);
      setTimeout(function () { _log('send 2'); ws.send('message 2'); }, 60);
      setTimeout(function () { _log('send 3'); ws.send('message 3'); }, 90);
    };
    ws.onmessage = function (event) {
      _log('event.data: ' + event.data);
    };
    ws.onclose = function () { _log('closed'); };
    ws.onerror = function () { _log('error'); };
    // ws.close();
  } catch (e) {
    _log('using WebSocket - Error: ' + e.message);
    //document.write('<font color="red"><h3>Error: ' + e.message + '</h3></font>\n');
  }

  _log('end of index.html');
})(window);
</script>
