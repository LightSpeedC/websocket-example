<!DOCTYPE html>
<script>
  var startTime = Date.now();
  function ms() { return (Date.now() - startTime) + ' ms'; }
</script>

<h1>index.html インデックス</h1>

<div id="container"></div>

<script>
  // https://github.com/james2doyle/saltjs
  // *! Salt.js DOM Selector Lib. By @james2doyle
  window.$ = function () {
    var methods = {
        '#': 'getElementById',
        '.': 'getElementsByClassName',
        '@': 'getElementsByName',
        '=': 'getElementsByTagName',
        '*': 'querySelectorAll'
    };
    return function (selector) {
      var el = (document[methods[selector[0]]](selector.slice(1)));
      return ((el.length < 2) ? el[0]: el);
    };
  } ();

  // probably the most useful and allows $('#iddiv').find('.inside')
  window.Element.prototype.find = function(selector) {
    return $(selector, this); };

  // doing a find in a NodeList doesnt really work. I had a function that
  // would look inside and get the element but it was pretty big and
  // required recusive searching inside NodeLists. So I would suggest just
  // using a '*' selection method
  window.NodeList.prototype.find = function find(elem) {
    console.error('You cannot find in a NodeList. Just use $(*selector %s)', elem);
    return this; };

  // another useful one for doing $('.inside').each()
  window.NodeList.prototype.each = Array.prototype.forEach;

  // $().attr('prop', 'value') support
  window.Element.prototype.attr = function(name, value) {
    if(value) {
      this.setAttribute(name, value);
      return this;
    } else {
      return this.getAttribute(name);
    } };
  window.NodeList.prototype.attr = function(name, value) {
    this.each(function(el) {
      if(value) {
        el.setAttribute(name, value);
      } else {
        return el.getAttribute(name);
      }
    }); return this; };

  // $().css('prop', 'value') support
  window.Element.prototype.css = function(prop, value) {
    if (value) { this.style[prop] = value; return this; }
    else { return this.style[prop]; } };
  window.NodeList.prototype.css = function(prop, value) {
    this.each(function(el) { el.css(prop, value); }); return this; };

  // $().on('event', function(el){});
  window.Element.prototype.on = function(eventType, callback) {
    eventType = eventType.split(' ');
    eventType.forEach(function(ev) {
      this.addEventListener(ev, callback);
    }); return this; };
    //for (var i = 0; i < eventType.length; i++) {
    //  this.addEventListener(eventType[i], callback);
    //} return this; };
  window.NodeList.prototype.on = function(eventType, callback){
    this.each(function(el){
      el.on(eventType, callback);
    }); return this; };

  // $().addClass('name');
  window.NodeList.prototype.addClass = function(name){
    this.each(function(el) {
      el.classList.add(name);
    }); return this; };
  window.Element.prototype.addClass = function(name) {
    this.classList.add(name); return this; };

  // $().removeClass('name');
  window.NodeList.prototype.removeClass = function(name){
    this.each(function(el) {
      el.classList.remove(name);
    }); return this; };
  window.Element.prototype.removeClass = function(name) {
    this.classList.remove(name); // add->remove???
    return this; };
  // $().hasClass(name)
  window.Element.prototype.hasClass = function(name) {
    // contains? how annoying!
    return this.classList.contains(name); };
  // $().first()
  window.NodeList.prototype.first = function() {
    // if this is more than one item return the first
    return (this.length < 2) ? this : this[0]; };
  // $().last()
  window.NodeList.prototype.last = function() {
    // if there are many items, return the last
    return (this.length > 1) ? this[this.length - 1] : this; };

  var $container = $('#container');
  print(ms() + ': #container loaded');
  window.WebSocket && print(ms() + ': window.WebSocket ');
  window.MozWebSocket && print(ms() + ': window.MozWebSocket ');

  if (!window.WebSocket && window.MozWebSocket)
    window.WebSocket = window.MozWebSocket;

  var wsurl = "ws://" + location.host + "/ws/";
  try {
    print(ms() + ': new WebSocket() start');
    var ws = new WebSocket(wsurl, 'echo-protocol');
    print(ms() + ': new WebSocket() complete');
    ws.onopen = function () {
      print(ms() + ': onopen!');
      ws.send(ms() + ': message');
      setTimeout(function () { ws.send(ms() + ': message 1'); }, 30);
      setTimeout(function () { ws.send(ms() + ': message 2'); }, 60);
      setTimeout(function () { ws.send(ms() + ': message 3'); }, 90);
    };
    ws.onmessage = function (event) {
      print(ms() + ': event.data: ' + event.data);
    };
    ws.onclose = function () { print(ms() + ': closed'); };
    ws.onerror = function () { print(ms() + ': error'); };
    // ws.close();
  } catch (e) {
    //alert(e + '');
    document.write('<font color="red"><h3>' + e + '</h3>\n<pre>' + e.stack + '</pre></font>\n');
  }

  function print(msg) {
    if (!$container) return console.log(msg);
    var div = document.createElement('div');
    div.appendChild(document.createTextNode(msg));
    $container.appendChild(div);
    //$container.insertBefore(div);
  }

  print(ms() + ': end of index.html');
</script>
