<!DOCTYPE html>
<meta charset="utf-8">
<script>
  (function (w) {
    var cur = Date.now();
    function _msec() {
      var prev = cur; cur = Date.now();
      return ('     ' + (cur - prev)).slice(-6) + ' msec. ';
    }

    var msgs = [];
    function _log(msg) {
      msgs.push(msg = _msec() + msg);
      if (typeof $container === 'undefined')
        return console.log(msg);
      while (msg = msgs.shift()) {
        //var div = document.createElement('div');
        //div.appendChild(document.createTextNode(msg));
        //$container.appendChild(div);
        $container.innerHTML += msg + '\n';
      }
    }
    w._log = _log;
  })(window);

  _log('start');
</script>

<h1>index.html インデックス</h1>

<pre id="container"></pre>

<script>_log('before salt.js');</script>

<!--script src="salt.js"></script-->
<script>
(function (w, d) {
  'use strict';

  var methods = {
      '#': 'getElementById',
      '.': 'getElementsByClassName',
      '@': 'getElementsByName',
      '=': 'getElementsByTagName',
      '*': 'querySelectorAll'
  };

  // https://github.com/james2doyle/saltjs
  // *! Salt.js DOM Selector Lib. By @james2doyle
  w.$ = $;
  function $(selector) {
    var el = (d[methods[selector[0]]](selector.slice(1)));
    return ((el.length < 2) ? el[0]: el); }

  // probably the most useful and allows $('#iddiv').find('.inside')
  // $().find()
  w.Element.prototype.find = function find(selector) {
    return $(selector, this); };

  // doing a find in a NodeList doesnt really work. I had a function that
  // would look inside and get the element but it was pretty big and
  // required recusive searching inside NodeLists. So I would suggest just
  // using a '*' selection method
  // $().find()
  w.NodeList.prototype.find = function find(elem) {
    console.error('You cannot find in a NodeList. Just use $(*selector %s)', elem);
    return this; };

  // another useful one for doing $('.inside').each()
  // $().each(function(el){})
  w.NodeList.prototype.each = Array.prototype.forEach;

  // $().attr('prop', 'value') support
  w.Element.prototype.attr = function attr(name, value) {
    if(value) {
      this.setAttribute(name, value);
      return this;
    } else {
      return this.getAttribute(name);
    } };
  w.NodeList.prototype.attr = function attr(name, value) {
    this.each(function(el) {
      if(value) {
        el.setAttribute(name, value);
      } else {
        return el.getAttribute(name);
      }
    }); return this; };

  // $().css('prop', 'value') support
  w.Element.prototype.css = function css(prop, value) {
    if (value) { this.style[prop] = value; return this; }
    else { return this.style[prop]; } };
  w.NodeList.prototype.css = function css(prop, value) {
    this.each(function(el) { el.css(prop, value); }); return this; };

  // $().on('event', function(el){});
  w.Element.prototype.on = function on(eventType, callback) {
    eventType = eventType.split(' ');
    eventType.forEach(function(ev) {
      this.addEventListener(ev, callback);
    }); return this; };
    //for (var i = 0; i < eventType.length; i++) {
    //  this.addEventListener(eventType[i], callback);
    //} return this; };
  w.NodeList.prototype.on = function on(eventType, callback){
    this.each(function(el){
      el.on(eventType, callback);
    }); return this; };

  // $().addClass('name');
  w.NodeList.prototype.addClass = function addClass(name){
    this.each(function(el) {
      el.classList.add(name);
    }); return this; };
  w.Element.prototype.addClass = function addClass(name) {
    this.classList.add(name); return this; };

  // $().removeClass('name');
  w.NodeList.prototype.removeClass = function removeClass(name){
    this.each(function(el) {
      el.classList.remove(name);
    }); return this; };
  w.Element.prototype.removeClass = function removeClass(name) {
    this.classList.remove(name);
    return this; };

  // $().hasClass(name)
  w.Element.prototype.hasClass = function hasClass(name) {
    // contains? how annoying!
    return this.classList.contains(name); };

  // $().first()
  w.NodeList.prototype.first = function first() {
    // if this is more than one item return the first
    return (this.length < 2) ? this : this[0]; };

  // $().last()
  w.NodeList.prototype.last = function last() {
    // if there are many items, return the last
    return (this.length > 1) ? this[this.length - 1] : this; };
})(window, document);
</script>

<script>_log('before main script');</script>

<script>
  var $container = $('#container');
  _log('#container loaded');
  window.WebSocket && _log('window.WebSocket ');
  window.MozWebSocket && _log('window.MozWebSocket ');

  if (!window.WebSocket && window.MozWebSocket)
    window.WebSocket = window.MozWebSocket;

  var wsurl = "ws://" + location.host + "/ws/";
  try {
    _log('new WebSocket() start');
    var ws = new WebSocket(wsurl, 'echo-protocol');
    _log('new WebSocket() complete');
    ws.onopen = function () {
      _log('onopen!');
      ws.send('message');
      setTimeout(function () { _log('send 1'); ws.send('message 1'); }, 30);
      setTimeout(function () { _log('send 2'); ws.send('message 2'); }, 60);
      setTimeout(function () { _log('send 3'); ws.send('message 3'); }, 90);
    };
    ws.onmessage = function (event) {
      _log('event.data: ' + event.data);
    };
    ws.onclose = function () { _log('closed'); };
    ws.onerror = function () { _log('error'); };
    // ws.close();
  } catch (e) {
    //alert(e + '');
    document.write('<font color="red"><h3>' + e + '</h3>\n<pre>' + e.stack + '</pre></font>\n');
  }

  _log('end of index.html');
</script>
